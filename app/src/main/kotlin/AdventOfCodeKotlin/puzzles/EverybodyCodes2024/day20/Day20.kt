package AdventOfCodeKotlin.puzzles.EverybodyCodes2024.day20

import AdventOfCodeKotlin.util.Adjacent
import AdventOfCodeKotlin.util.Node
import AdventOfCodeKotlin.util.Graph.Companion.buildGraph

fun main() {
//    Day20.part1()
//    Day20.part2()
    Day20.part3()
}

class Day20 {
    companion object {
        fun part1() {
            val input = """
                #..............S..............#
                #.............................#
                ###-###-####-##-##-####-###-###
                #.............................#
                ###+###+####-##-##+####-###+###
                #.............................#
                #-###-####-#########-###-###-##
                #.............................#
                ###-###-####-##-##+####-###-###
                #.............................#
                #-###-####-#########-###+###+##
                #.............................#
                ###-###-####-##-##-####-###-###
                #.............................#
                #-###+####-#########-###-###-##
                #.............................#
                ###-###-####+##-##-####-###-###
                #.............................#
                #-###-####-#########-###-###-##
                #.............................#
                #+...+....+....+....+....+...+#
                #+++.+++..+++..+..+++..+++.+++#
                #..+...+....+..+..+....+...+..#
                #..+...+....+..+..+....+...+..#
                #.++..++.+.++.+++.++.+.++..++.#
                #.++..++.+.++.+++.++.+.++..++.#
            """.trimIndent().split("\n").map { it.toList() }

            var start: Node<Char>? = null
            val graph = buildGraph(input, ::Node, { it != '#' },
                mapOf('S' to { _, node -> start = node })
            )

            val altDeltas = mapOf('.' to -1, '+' to 1, '-' to -2)
            val bestAlt = mutableMapOf((start!! to start) to 1000)
            var toProcess = mutableSetOf(Triple(start, start, 1000))
            repeat(100) {
                toProcess = toProcess.flatMap { (from, to, alt) ->
                    to.getNeighborNodes().mapNotNull { neighbor ->
                        if (neighbor == from || neighbor == start) {
                            null
                        } else {
                            val newAlt = alt + altDeltas[neighbor.value]!!
                            if (newAlt > bestAlt.getOrDefault(to to neighbor, Int.MIN_VALUE)) {
                                bestAlt[to to neighbor] = newAlt
                                Triple(to, neighbor, newAlt)
                            } else null
                        }
                    }
                }.toMutableSet()
            }

            println(bestAlt.values.maxOrNull())

        }

        fun part2() {
            val input = """
                ##############################################################################S##############################################################################
                #-+-.--...-...#+.+-+++.-+--+...-----..++-...+-.--.#-#.#+--+#.#-.-.+..-.-+.#..-..+.....-..--++.--..#+--.##+#---++-.---+-#-.--.-.....+-.-+.--#--.-..#.++-.#-.+#
                ##.+++--+--...++.+.-+-..#..-.-..--.-..---.--------..----.---...-#.++-.++.--###+...-...-..+...----..--.---..--.--.--..--.--.-.-----#.-+#-.#++.+-#--+.-+...-..#
                #.-.-.-#.#-++##-.....-.#+#-#..++#-##+-.#-#-+#.#-#-#--...+#+#+.+...#.-.#-#-.-#+++....+.....##-.+..++.+++--.-+#.#--..#.#-+.-#-#---+#-#.+-#+#..+.+---.-..+#+.+.#
                #-+..++..++..#-..##+#+#-#...#..#...#--#...#+.#...#+-.-#.-+++..##+.-.--..-##-+++++--.+.+.-..--.++.-+--.-..#.#...#..#...#-.#...#.+#...#..-#.---+.##-.-+--.-+++#
                #+..+.-.........++-++..#..A..##.....##.....##.....#..#.+.+--#-#+..+.-##.-..+++++++.---#-..#+.-+.-#-+...-..#.....##.....##.....##..B..#++#--#+#-+....-+.+-.-.#
                ##-+.++..#+..+#..##+---.#...#-##...#--#...#..#...#+#.-.+#.--+#+.+-#-.+.+#..#+++++#.--.+-..--.+-.-.--.-..+..#...#-.#...#-+#...#--#...#.-.++#.#..++-#.-.--..-.#
                #.-+##..-#....+.++.#-.#.-#-#.-..#-#+##+#-#..--#.#..---...--..-+----.#-......#+++.#.+.-.+#..-..#.-.#..+.-+-+.#-#.#..#-#+--.#-#-.+.#-#.+##--...+.-#++..-#-#+#.#
                #-.-+......-+++.+..-.+#-.+#.-.----...#...-.--..-#...-...--#++..+.-.+..-#++-#--+-#-++......++-..-..+-.#...-.----+-#+.-#-..#.-+#.+...-.--..---+..--..#..-++.#-#
                #+--.--...+...##-++#.#-..-..#--.--..-..--#..-.+.-.....+..---.+#+#...+.....-.-.#+#..-....--.-#.--.---#.-.+--#.-.--.++...#+--.+.+.#.-.###.-........--.+.+#.-+.#
                #-#-#-##+-+#-+---+..-.--...++..+-.-#.+-+#.-.+..-..--+..#+-.-+-+.#-++++..+--.+..+.#-....-.--.-+#.+.....+..++.-.+---++-+..###..+-..+--..+#+#++.+#.-#.#--++.+..#
                #-...-.+.--.+.--+..-+-+--+-+.-#++##--#...-+.-#..-.+.+.-.-+--..#+-.+..+...++..-++.#-...---#+...#-.-#+.#..---.....+..#-##-+.---.++#...-+.--#.--#.-..-....+-...#
                #.....++.-#-+..-+...#-++.#-++#.#-.-.-..+.-#-+#.-.+#+...+-#..-..--+#+.+.---..++.+-+#.-#.-#-+.#++..#+.##..#+.-.-.+.#--##-##...+...-+...-+-.-+.--.#-..++...++-.#
                #..+.+...-.--.+..+-.+....+.#--+.+.#+....+..+-......-----...-#.--.-#-.#-++-.##.#.##...#+.-.--.-...+++-+.-+-.#.++..++.--.#..##++-...+-..#.+-.#-..--#.--+#-++#.#
                ##..+--.##-#..---...+.-#+-.....-#.--+..+....--.+-+-.+.---+-..+-++....-.+.-.#.+-#..+--...-+-##.+.###+...#...-.++..-#-....+.--++-.+.-.....-+...#..#-#+.---....#
                ###+--#...#-#.#-+-+.+#.#---+#...-+#.+..+.#-.++----..-.-...#.+--+.+--#-#.-##+-..-..#..-.#-#---+.--#-..-+#+.#.+.#.-..+-+.#-+.....#...-#+.-...-.-+-.++--+.--.-.#
                #..-++-#.....+-..---#.....+.#.-+#.#.-...#.-.-#-.+.-..#++#---#+-..#+--#+..+#+-.+##+.#.+##.-.......+-#+..+#.---.+#.++.+-..++.-..#-.#..+.-+.#-.-.+...+.-.+.--..#
                ##.#.#..+-#++..#.+#+-..+-..+-+++..--++..#.++--#+###.#.-..##..-.--#.---#+.#..---.........#+#-.+++.#++#....--.-#+#..-.-#++.-#--+...--.+--+.+....--.+---+-.+---#
                #+..+....-+..+#----+#++#.+--##---...---.++-#-...#++.-.#+-+#+.-+--##...-#...#..#+#+-.-.+#--+.+--+.+...+....-..##+.+-.+.#..--.+++-+.-.-..#+#..##+--##+.---###-#
                #.+..-.-..++#---.+-.--+.#..+-#-#.#..+-#.+-+.+-..++.+++-..##.-+.#++--.#-.+##..+..-.+#.------++#.+#.+#-.-#.-..#--#.+..+.#.#..##.+..+.---#+.++.+...#..+-....+-.#
                #-+..#.+........-.-#--..+-#+....#-..#.-.+.--+#-#..-+-..####..-#-+-.+..-....-.---#...#.-+---..-#-#+.##-++---..-....#++-#.++#++.+-..-++.--#+++...#.-.++-.###.-#
                #--+++#--....----.-#..+++.#....++..+-.#-.--+...#+.-..--..+.+...-#-...#.-.-#+#+..#++.-.+#++##..++..-+##.+#+##.+-.+....#+-#..--.+-#-+.-.+.....+.++..-##-+-.-.##
                ##-.-..-.#.#..-.+--+.-.-+-#--++-++++-.......+#.+..-+#+---#.#++.+++.-.-+-#..+--#--..-..-+.+##+.+...----#.#..---..#..+....+..-.-..++#-#....#.......-+-..#.-...#
                #-#-.-.-..-...-..+...++..###.-.-#.-..#.-#+.-#++-+-+.#.+.+---.++#-.-.--.--#+#+.+-+..#.#..+.+#--..--..-..+...#-.#--+#-##++....-.#...##-+++#--#++..+##+.+.-+-.-#
                #.+..--.+-+.+...++...#-.....+-...#-....-.###+--+#.#.-....-.++.#-...++.###--.-#..--++++-++-+....-.--.-.----++++----.+++-+#-.---##.-.-..-.+.-##+#-.++-.-+-+---#
                #+..#+.#........#+--.-.#+.--.+-#-.-.--..-.-...#-.#.+++..-+--.-.-...+-..+.++++.+#.--+.+-.-..+-+..+#-.-+.-++++++--##-.-+.+..-#-.##-.#--.-+++-..+-+.+..#+-...#.#
                #-..+++###--+.#++.+.-.#.+.#-.-+.+.-+-...#-.+.+.-.--.#-++##..-....--+-+.#.#+.+-.+.#+.+..-+-..+-..#+-..-+....-#+..+.--++...-###-..---..-#.#+....+#-.++-##+#..-#
                #+++-+-+.-+#-..-..+.--+-+-+--+#....####-..-.#.+#..-+--+..++++#.#+.+----..-#...#++.+--.+.#-.+..#.+.-.-.-#+#+.#---..-..--+-#++..+-.....-+#-#..+#.--+..#+##--+.#
                #.+++.#-+-.#-+..+.-....####+#++...-.#-+++..-.-+..--.#-.++#.+-.##........--#.#.-.-+.+#....--+.+..-#....----+.--++--......-.....-.#.+#++++-.--+.-+...--##.---.#
                #.+#-#.+#..+.#-#.---#.++.----+.-#+#--+.#..#-+..+...---#-+.+#+.+--++..-.#..++.--#..#-+....-..#+..+-.#-.-#.+.-...##+.#...+##..--.....+-.-.+-.+.#.-+.-.-..++.+.#
                ##-#-.-+.-.+.#+.#-.-.#--.-+.+..-.-.-##+..#..--..-...--#.-#.-##...#--.+.+-##.-###-...##--.+...+..#---##-#..+#++--+##+.+.+-....#--+..+.....+.#-.+.+...+#-.-.-+#
                #.#..-.+.#+.-+#-#-.####..#---.-+..-#-.#++.++++--+....--+++.....+.+-.#.++.#..+#.--+.+.#.-....++#--#+-#..+..--.-+...-.+.++..-...-#..+##...##-.-+#...++-#.-#..+#
                #..-.#-....+.+.-++-+-.---#+-.#.-+.+..--.##--.#-+---+-+.+.+.-..+-.#+..+..#-.+-+--..--++..-+-+++-.--#-+###+--.++.++-.-+-+-#.-.-...-.-+-.#+.#..+..++.++.-.++++##
                ###---.+--+.-.#+-+-#.-#+.+.###+-+.-..-+..--.++#+.-.-..----....#-+-..-....+...-.##-.##+.+--.+....#..+-.+-++#+#++-+--.+-##.+#-++.+..--...--..-.-.-..-..-.+++#.#
                ##.....#..+-.-..+--#+#-+---+-.--.+.++-+..###-#--#....+---++.#-#--+...#--#-+-+.+-+.--#-#-..++-.#+#...--+++..--.-+#.-.#..#-..##..-.......++.-.+--.----...#..-##
                #.++-..-+.--...+-+++++-.-.#.-+-.--.+-##+..-..++.-.-+--#.#+.++--+--#-..-#..#.-..+-##.-+-#+--.#.+#--.-.+.+..#+.-#-.-++..+.#.....+.+-....---..-#.+-...++++.-+..#
                #-#-#.#.-.-+.#.-...---.--+-.-..+.++-..+--+---+....#....+.--.++..+..+-+...+.-.-#+.#+-+.+-+..#+.-.-......---..+.++.+#.++++#.+.+.#..#-.+..++.-.-.+-#..++##.#.#+#
                #.--.+.--##.#-+#++..-....+-.-++.+--##..--.--.+.+.#+--.+.-..--+#.....--#+----.++.-.-#++-+#.-#-+#..+.-+-.+--.+.#-----.++.+-..--+#..-.---+..+-.+.--...-+.##-..+#
                ##-+-#-.+++........-+.--+....--#+--+#.+#..-.---.-.-.-.+.+---.++-+-.-....+#-.-.-...---+#-+.-...-+++--.###+.+-+#.+#-#++.#++...-+.+.-....--+..+.+.--#.#+.-.-.-##
                #..--.--+.-+.++-..-+...#...++.+.....+..--..+.#.#+#.+---.#.--#+.#----.--..+#.#...+..#.#-+.-.-#...#+-.-...#.#.-.#-#...--#..-++.+#+..+++-+..#---#.+---++#+...+.#
                #.-.-#...--++.-......#+#.-...+.--.###.##-+-#.+.-+-..++++#--.+-..-.-.-.-...+-#.-+--++.+-.+.#-.--.--+..+.++.#+.+#+----.+...--#.+.#.#+#.#-.--#-.#..+...#+..+.+.#
                #..+...+.+-+-..++#+...-++++-#++.--.-..-#.-+-#+.+#-.-#-+-..+.#-#.-#-#..--#..++#..---.--.+.---.##+-.+.+-+--...---.-....-#+.---+..++--#..+..+.-.+.++.-#.#-#+..##
                #--.--++---.--#..+##+.-#+++...--.-#-.-###..#-#-.-.####.+.--..-+.###..--.#.#-+###.+-.-#-+++###..--.-..+.###-#-++..--.###--.+#..++.##.#+.-..-+-+.+.-..--+#-...#
                #--.--.-..-+..#.--.+..+--#..##+--.+###...##.-.-.+##...##.+#+..##...##.+-+.+##...#####+++##...##+-.+-.##...##-.+-+###...##..-+...++#-.--#--....--..+-.-.-.-.##
                #-..------.--......---.----.-----......C..-#++++++++++++++++++++++++++++++++.....-.-.--.-.....-.-.--.-.....--.--.........-.-...---...-.-.-.-..--.-.-..--.-..#
                #.--+.+.#+-.-##.+++.#-...+#.-+-++.-.##...##.#..#.##...###..#..##...##..+-++##...##.-....##...##-.-#####...##..--+-##...##-+-.--+-.-.+.#.+..+--+-+.++..-++.+.#
                #..--+.#..+-.---+.-.+....##.+.+..-.++-####..++-+..#####--...-...####++.-.--+-###-++--+#+--###+++.#..-.####..-.-##+--########-##-+#+#..#...--.---..-.-++##-+.#
                #..#.#+-++#----.-.--+#.-+.#-.--.+#.-.+-..---.-...-.-+..----.++....+#.-#----..+-...--+#..--..#+-..-#-+...+-.+#.+.++#++.-++.-.....+-+-+.+.#..+..-.....--#++####
                #############################################################################################################################################################
            """.trimIndent().split("\n").map { it.toList() }

            data class State(val previous: Node<Char>, val current: Node<Char>, val alt: Int, val distance: Int, val checkpoints: Int)

            var startTemp: Node<Char>? = null
            var aTemp: Node<Char>? = null
            var bTemp: Node<Char>? = null
            var cTemp: Node<Char>? = null
            val graph = buildGraph(input, ::Node, { it != '#' },
                mapOf(
                    'S' to { _, node -> startTemp = node },
                    'A' to { _, node -> aTemp = node },
                    'B' to { _, node -> bTemp = node },
                    'C' to { _, node -> cTemp = node }
                )
            )
            val start = startTemp!!
            val nodeA = aTemp!!
            val nodeB = bTemp!!
            val nodeC = cTemp!!

            val routeTable = Adjacent.buildRouteTable(listOf(nodeA, nodeB, nodeC, start))
            val cToEnd = routeTable[nodeC]!![start]!!
            val bToEnd = routeTable[nodeB]!![nodeC]!! + cToEnd
            val aToEnd = routeTable[nodeA]!![nodeB]!! + bToEnd
            val minRemainingFromCheckpoint = listOf(aToEnd, bToEnd, cToEnd, 0)
            val nextCheckpoint = listOf(nodeA, nodeB, nodeC, start)

            val altDeltas = mapOf('A' to -1, 'B' to -1, 'C' to -1, '.' to -1, '+' to 1, '-' to -2)
            val bestAlt = mutableMapOf((start to start to 0) to 10000)
            var toProcess = mutableSetOf(State(start, start, 10000, 0, 0))
            while(toProcess.isNotEmpty()) {
                toProcess = toProcess.flatMap { oldState ->
                    oldState.current.getNeighborNodes().mapNotNull { neighbor ->
                        if (neighbor == oldState.previous) {
                            null
                        } else if (neighbor == start) {
                            if (oldState.checkpoints == 3 && oldState.alt > 10000) {
                                println(oldState.distance + 1)
                                return
                            } else {
                                null
                            }
                        }
                        else {
                            val newAlt = oldState.alt + altDeltas[neighbor.value]!!

//                            // If the altitude is unnecessarily high to reach the end even with all drops, skip
                            if (newAlt - 2 * (routeTable[nextCheckpoint[oldState.checkpoints]]!![neighbor]!! +
                                        minRemainingFromCheckpoint[oldState.checkpoints]) > 10020) {
                                return@mapNotNull null
                            }

                            var newCheckpoints = oldState.checkpoints
                            if (neighbor in nextCheckpoint) {
                                if (neighbor != nextCheckpoint[oldState.checkpoints]) {
                                    return@mapNotNull null
                                } else {
                                    newCheckpoints = oldState.checkpoints + 1
                                }
                            }

                            if (newAlt > bestAlt.getOrDefault(oldState.current to neighbor to newCheckpoints, Int.MIN_VALUE)) {
                                bestAlt[oldState.current to neighbor to newCheckpoints] = newAlt
                                State(oldState.current, neighbor, newAlt, oldState.distance + 1, newCheckpoints)
                            } else null
                        }
                    }
                }.toMutableSet()
            }

            println(bestAlt.values.maxOrNull())
        }

        fun part3() {
            var alt = 384400 - 5
            var south = 0
            val diffs = listOf(1, -1, -1, -1, 1, -1, -1, -1, 1, -1, -1, -1)
            var index = 0
            while (alt > 0) {
                alt += diffs[index]
                south++
                index = (index + 1) % diffs.size
            }
            println(south)
        }
    }
}