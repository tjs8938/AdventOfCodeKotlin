package AdventOfCodeKotlin.puzzles.EverybodyCodes2024.day17

import kotlin.math.abs

fun main() {
    Day17.part1()
    Day17.part2()
    Day17.part3()
}

class Day17 {
    companion object {
        fun part1() {
            val input = """
                *.........*.........*
                .....................
                .........*....*...*..
                .....................
                ..*....*....*........
                .....................
                ........*...*........
                .....................
                *.....*...*...*.....*
                .....................
                ........*...*........
                .....................
                ........*....*....*..
                .....................
                .*...*.......*.......
                .....................
                *.........*.........*
            """.trimIndent().split("\n").map { it.toList() }


            calcConstellationSize(input)
        }

        private fun calcConstellationSize(inputList: List<List<Char>>) {
            val stars = inputList.flatMapIndexed { rowIndex, row ->
                row.mapIndexedNotNull { colIndex, c ->
                    if (c == '*') {
                        rowIndex to colIndex
                    } else {
                        null
                    }
                }
            }

            class Edge(val first: Pair<Int, Int>, val second: Pair<Int, Int>, val distance: Int) : Comparable<Edge> {
                override fun compareTo(other: Edge): Int {
                    return distance.compareTo(other.distance)
                }
            }

            val edges = stars.flatMap { first ->
                stars.mapNotNull { second ->
                    if (first != second) {
                        val (x1, y1) = first
                        val (x2, y2) = second
                        val distance = abs(x1 - x2) + abs(y1 - y2)
                        Edge(first, second, distance)
                    } else {
                        null
                    }
                }
            }.sorted().toMutableList()

            val firstEdge = edges.removeFirst()
            val constellation = mutableSetOf(firstEdge.first, firstEdge.second)
            var distance = firstEdge.distance

            while (edges.isNotEmpty()) {
                val edge = edges.first { (it.first in constellation) xor (it.second in constellation) }
                distance += edge.distance
                constellation.add(edge.first)
                constellation.add(edge.second)
                edges.removeIf { it.first in constellation && it.second in constellation }
            }

            println(distance + stars.size)
        }

        fun part2() {
            val input = """
                **.....*..*............................*.............*.............................*...*............*
                ........................................................*.............*..............................
                .........................*..............*.......................*....................................
                *....*.............*..*......................*....................*.............................*....
                ......................................*.................................................*......*.....
                ..........................................*.............*.......................*....................
                ......*....*...............*..........*.........................*....*............................*..
                ....*..........*..*.......................*...............................*................**.......*
                .........*..........*.........*.*....*..................*............*.........*....*................
                .........*..........................*...*........*..........................................*........
                .*............................................*........................*.............................
                ....................................................................*................................
                .............*............*....*...............................................*..................*..
                ......................................*................*..............*.............*......*.........
                ....*........................................................*........*..............................
                ..*.....................................................*............................................
                ...................*..........................*...*..................................................
                ..*.....*....*....*........*...........................................................*.............
                .........*................................*..*.*..............*.................*...............*....
                .....................*.........................................*.*...........*......*.....*..**......
                ...*.................*.......................*..*.....*..............................................
                ............*...........*.............................*.......*...........*..*.........*.*..........*
                ............*..*..................................................*..............*...............*...
                ...*................*......................................*.*..*.........*....*.....................
                ..................*..............*................*....*....*..........*.......*.....................
                .........*.....*...............*.................***............*..................................*.
                ............*.....................................*........*...........*....*...............*........
                ............................................*................**....................................*.
                .........................*......*....*..*..........*............*..................................*.
                .....................................................................................................
                *.......*..*.........*.*.........*................*.............*....................................
                .........*....*..........*...........................................................................
                .....*....................................*......*...............................*..*...*...*........
                .*......**.........................*....................................*.......................*....
                ...................................*....................*...***........................*.............
                .....................*....................*..............**..*..............*........................
                ..................*....................*..........*...................*................*..........**.
                .........................*............................................................*.........*....
                .......*....*.........................*..................*........*..................................
                .*....................................*..............................................................
                ..............*..........................................*.......*.....................*.............
                ..........................................*...*..................*...*.....*.........................
                .................*...........................*.....................................*......*......*...
                ..*...*........*.............*...........*..................*..........*..................*..........
                ....................................*................................................................
                ........*.............*......***..........................................*............*.............
                ..................................*.................................................*................
                ..................................*...............*........**...........*............................
                *.....*............................*........*...............*.............*..*........*..............
                .................................*..*...........*..................................................**
                *........*................*..............*...........*.................*..*.....*...*...*.*........**
            """.trimIndent().split("\n").map { it.toList() }
            calcConstellationSize(input)
        }

        fun part3() {
            val input = """
                *.......*............*...............................*..............*...........................*........................*.........................................................*....................*
                .................*................*.....*.......**.*................**..........*..*........................................*...........................*.....**..........................*....*.*.......
                .......*.*......................*.......*.....*......*..........................................*.*..........................................................................*..............*..........*.
                ..............*..................*....................................................................*........**.....................................*........*.............*......*.*..................
                ...............*..................................*..................................................*......**........*.....*.....................................................................*......
                ......................*....**..........*..............*..........*........*..........*.................................................................*.................................................
                .*.........*..*....................*.*.*................................*.................*..........................*..................*...............*.......*.............................*..........
                ......*.............................*..................*.....*.....................*......................**..............*........*.*....................*.......*...*........*.........................
                ............................*..*...........*.................*..........................................*..............................*.......*...............................*..........*...........*..
                ...........................................................................................................*.......*..........*.*.............*.......*.....................................*............
                .....................*....................................*..........*....*...*.............*..................................*...............*.....................*................*..*...............
                .....................*........*...*...*....*...*......*........................*.*........................*............*.................................*..*.....*.......*.*............*...............
                ......*............................*.*......................*................*..*.............................................*...................*......*..*............................................
                ..........*.................*.......**.......*..........*...............................*........................................*............*............*........*.......*..........*..........*..*..*
                ......**........*...................*.....*.........*.......*.............................................................................*..................*...........................*...............
                ..........................*.*.....*........*.............*.........*.......................................................................*....*............*........*.......*..............*...........
                ........................................................*.......................................*............*.......................................*...............*.......*...........................
                ......*.....*...*...*....*......*........*.........................*...................................*...........*............*......*...................*..**........*......*....................*....
                ................*............**....*............*......*.....*.....*........**.*........*......*..............**...............*...............................................................*....*....
                .......................*.......**......*...................................................*.......*................*.........*..................................**......*.......*.......................
                .............*.........*.....*................*..................................................*..............*.............................................................*..........................
                .*.............*......*....*.*.......*..*..........*..........................................................*.........*....*...............*...*.......*.........*.......*......*......................
                ...........................*.........................................*..............................................*...............................*.....................*.................*............
                .*..................*.......*......*.....*...................*..............*.................*..........*.....*......*........*.......*.............................***.*..*.......*...*................
                ......*..*...*.....................................................................*........................*.................................................*..........................................
                *..................*......*.....*.*..............*............................*........................*................................*.*...........................*...*...*......*...........*.......
                .......................*.*.*........................................*......................................................................................................*.............................
                ........*.........*......*.*....*.....................*.........*.................*......................................................................*............*.*......*......*..................
                ..*.....*..................................................*..............................*...............................*....................................................*.........................
                .*...............*......*......*.........*.......*..........................*....*....*.......................................*...........*.....*..................*.*...*......*......*..........*..*...
                ..................*.......................*...............*.............*.......*...................*...........*.*........*.............*................................*..........*...................
                .......*..*.....*......**.....*...........*...............*.....................*................................*.*............*........................................**......*......*...........*....
                *...............................................................................*.....................*.........*........*..............................*................................................
                ...............*......*.....*..............*....................*................................................*.....................*.......................*............*.....*......*.............*.
                .....................*..................*.*...................................................*..................*............*......................................*..*.....*...*......*...............
                ....*.........*.*...*......*...................*..................................................................................................................**.........*......*.*...*.......*......
                ...........................................................*..................................................................*...........................*...............*........*...........*.........
                ...*.........*....*.*.....*.................*...............................*....................................*......................*.*.........*........................**.....*.....**.............
                ........*.............*.........................................*...................*...............................*......................................*..............................*..............
                ..........*.*.*....*.....*....*...................*..*...............*...*...................................*...*.................*..**........*............*............**...*.....*.....**............
                .........*................................*.........*......................*....*.*............................................*...*.......*.*...*..*....................................................
                .....*.....**.....*.....*.......*.........................*...............................................*.......*.............*...............*...*.................*........**.....**.....*........*..
                ............*............*..........*..........................................*..........*.........*...............*.............................*...........................*.......*..................
                ...........**....*...*.*...............................................**............*...............*.....*...........*....................................**.*.....*.....*..*.**.....*.....*...........
                ............*...*......*.....*.....*..........*......*...................................................*.....................................*..........................*..............................
                ..........*.....*......*............*........................**.................................................*.......................*...........*..................*.........**.....*.....**.......*.
                ...................*....................................................*.*............*..............*...*.*...........*...*...............*.................*...*....................................*.
                ........**......*.....*.*............................*.........................................*.......................................*..................*................*...*..**....*......*.*.......
                .......................................*........*..............*.......*....*......*.....*...........*......................................*............................................................
                .........*.....*....**..................*......*.......*......................*...*..............*....*...........................*................................................*.....*.....*.........
                ............*............................*......................*.............*.......**.....*...............*.............*................................................*..........................*.
                ........*.....*......*................................................*...................*.............*........................................*.................................*......*...*.*........
                *............................................................*.............*............................*...................*....*.................................................*..........*..........
                ........*.....*.....*................................*........*.............................................*...........*.....................................................*.....*.....*.....*........
                ..*.................*....................*...*...........................................................................*.............*.................................................................
                ......**.....*.....*...........................*..........*..*...............*.....................................................*.............*...................................*.....*.....*.......
                .................................*.....**.....*......................**................................***...............................................................................*...*...........
                .......*.....*.....*...*...*..................*........................*.........................*............*........................*....................*........................*.....*.....*.......
                ..........*..........*...................................*..*............*...............................*...*.*......*.................*...............*..........................*...*....*........*...
                ......*.....*......*...............................................*.........*...........................................*...*..*...*......*...............**....*...................*......*.....*......
                ....*................*....*................................................*...........................................................*.............*....................*............*.....*..*.....*..
                ......*.....*.....*.....................*................*.*...*.........*.........*....................................*....................*.....................*..................*.....*.....*......
                ..................................*...................*............*.........................**.................*..**........................*..*.......*...............................................*
                ......*.....*.....*.........*............**.*...............................*......................................................*..*...........................................*.*.*.....*.....*......
                ................*...........................................................................................**......................*......*...........*..................*..............................
                ....*.*.....*.....*.......*...................*............*.*.....*............*......*...................................................*..........................................*.....*.....*.....*
                ...............*.*...........................................*............*...........*.....*......*.*.*.*.*.*.*.*.*........*..........*.......................*......*........*.........................
                .....*.....*.....*..........................................*..................................*.*.*.*.*.*.*.*.*.*.*.*...........................*..*................*..............*..*.....*.....*.....
                ...........*.......................*.....*...........*.................*.....................*.*.*.*.*.*.*.*.*.*.*.*.*.*.*................................*..............................................
                .....*.....*...*.*......*.......*.........................*............*....................*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.....*.*................................................*...*.....*.....*.....
                *..................................................................*.......................*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.....................*.*........*.....................*........*...*.........
                .....*.....*.....*.........*........................*...........................................*.*.*.*.*.*.*.*..**...*.*.*.*......................*....................*..............*.....*.....*.....
                ....................*.............*..................*.........*.............*.*.*.*.*...........*.*.*.*.*.*.*....*....*.*.*.*...............*...........*........*...*...................*..*...........
                .....*.....**....*..........*.................................................*.*.*.*.*.*.*.*.....*.*.*.*.*.*...........*.*.*.*................*...................*...*...........*...**....*.*...*.....
                .......*...*.......................**..*.*............*...............*.*........*.*.*.*.*.*.*.....*.*.*.*.*.*.........*.*.*.*..................*.................*....................*.................
                ...*.*.....*...........................................*................................*.*.*.*.*...*.*.*.*.*.*.*...*.*.*.*.*.*......*.......................*......*..*.*....*....*.*...*...*...*.*.....
                **..............**....*..............*..................*....*..........*..........................*.*.*.*.*.*.*.*.*.*.*.*.*.*..................................*...........................*..*.....*...
                .....*.....*.....*.........................................*..*...*................*.*.*.*.*.*......*.*.*.*.*.*.*.*.*.*.*.*.*.*................................................*....*..*.....**....*.....
                ......................*.*....*..............*.........................................*.*.*.*.*......*.*.*.*.*.*.*.*.*.*.*.*.*.....*.........*........*..*.*...................*.........................
                .....*.....*.....*..........*........................*.*.*.*..........................................*.*.*.*.*.*.*.*.*.*.*.*.*...*....*...................*.............*......*......*.....*.....*.....
                .............................................*.................*.........*.............................*.*.*.*.*.*.*.*.*.*.*.*.......*.*......................................*....**....*..........*....
                ....**.....**....*..............*..*...................................*..*...............................*.*.*.*.*.*.*.*.*.*..........................................................*.....*.....*.....
                .*......*......................................***............................*..*...................*.......*.*.*.*.*.*.*.*...............................*.............................................
                .....*..*..*..*.**.................................*..............................................................*.*.*.*.*...........*....*...............*........................*..*.....*.....*.....
                ............................................*........*.....*...............................................*............*..........................................................*.....................
                ....***....**.....*.........................................................*....*..................................*............*...............*....*...............................*....**.....*......
                ........................*..*.......................*......................................................*.............................................................*................................
                .....**.....*.....*.............................................................*....................*..............*..*.....*.*......*.*.......................*..............*......*.....*.....*..*...
                ..............*...............*.....*......................*..............*....................*..*...................*......*..*...........................*......**.*..................................
                .....**.....*.....*..*............................*.....*..........*..........................*........................*....*..........*................................*.............*.....*..*..*......
                .....*.........................................*.......*...............*.................*......*.............................*.......*..................................................*.....*.*...*...
                *.....*.....*......*.....*...............*......*..........................*...*........................*....................................*...........*........**..........*......*......*.....*..*...
                ...*..*...............................................................................*............................*...................................*......*............*.*..*....*.............*.....
                .......*.....*...*.*..........................*.........................................*...........*..*............................................*.*...........*..................*.....*.....*.*.....
                *.....*...................................................................................................*.............................*............*...................*...*........*..................
                .......*.....*.....*..............*.........................................*..*........................*.......*........................*...........................................*.....*.....*.......
                ....................................*...............*......*...............................*...............................................*..........*.......*.....................*...*...............*
                ........*.....*.....**....*.........................................................................*...............................................................................*.....*.....*........
                ..........................................*......................................................*.*..*..........................*...........*.......*.................................*.*....*..........
                ........**....*......*.*................................*.......**..............................*....................*....................*...........*..........*...............*.*......*.....*........
                ..................................*............................*..........................................*...............................................*..................*....................*......
                .......*.*.*...***...*...................................*........................................*............................*.............*......*.............................***....*.....*........*
                .*........................*..............*..........*..................*...........*..........................................................................*.....................*........*...........
                .........*......*.....*.......*..*.............*..................................**...*.........*...........*.............*..........................*...........................*.....*...*..*...*.....
                ...*....*........*.................*....*..............................................*..............*.......*...........*...*.......*..........................................*...........*...........
                ..........*.....**.....*...............................................................*...............................................................*.....*......*............*......*.....*.........*
                .....*...........*.*...*..........................*.........................*.........*............**..*................................................................*................................
                ...........*.....**....*........*................................................................*......*...........................*....................*...*...*........**.....*.....*..*..*...........
                ....*............*..............*......................................*............................*..*.........................*...*....*..............................................................
                ...........*......*....**............*.*...............*..........*.............................*.......*....*.......................................*...*....**................*.....*......*...........
                ..............................................*..............*..*................*.........................................*.........*...................*...**............*......*....*..........*......
                ............*......*.....*......*........................*..*.....................**.........*...*.............................................................................*.....*......*............
                ..........*............*.............*......*...*......*.......*...............................................................*........................................................*.....*..*.......
                ..*..........*......*.....*........................*...............*..*............................................*.*......*.*....................*...................*......*.....*......*....*........
                .........*...............*...........................*.....*...................................*.......*....................*...................*........................................*...............
                ..............*.....*......*................................................................*..........*...................................*.................*...............*......*.....*..............
                ........*......................*..........*.................................................................*.....*.*.............*...*.....................*...........*.......*............*......*....
                ...............**.*...*.....**............................*..........*...........*..........*...................*..............................................*.........*..*.....*......*.*.............
                ...*.............*....................*.......*......................................*........................*............*.........*..................*......*.......*..........*......................
                ................*......*..*...*..................*.....*.*..........*............*.......................*.....*..........................................................*......*......*................
                ......*.*................................*.*.*................*...*................*.........*...............*...*.............................................................*...............*.........
                ..*.*.........*..*......*......*...........*.............................................*.....*..........................*.........*................*.......*...........*....*.*......*......*..........
                .........*.............................................................*..........*...................................*...........................................*.........*............................
                ...**.......*.....*......*......*....................................*.....*...*.........*.....................*..............................*..................*..*...*......*......*..................
                ..............................*.........................*..*.........................**.......**..........................................*.............*.................*..............................
                .......*...........*......*.......*..........*........*..*........*.....*.............*...........................................*...................................*....*..*......***.................
                .........................*.......................*..*.....................................*........*.............*.......*..................................*.......................*....................
                ....................**......*......*..........*.................................................................................................*.*..........*.......*......*....*.**...*................
                ...........................*.........*..............*................................................*.*.................................................................................................
                ......................*...*..*.......*............*.........................*...............................*..............................***.......*.....*.......*.......*......*......................
                ....*...................*......................*................*.................**.............*.*.............................*...............................*............................*..........
                .......................*.......*....*..*...........*.........*................................................*....*..........................*..*.........*.....*..*....*.....*.*.......................
                .............................................................................*........*.......**.............*.........................*............*...............*....................................
                ....*.......*.*..........*......*...*....*................................................*.................*.*................................................*........*.....**....................*....
                ......*.......................*.*..............................................*.................................*..................................*.....................*..*...........................
                ...*........*.............*......**..*.....*.*.............*.............*.....................*.*...................*.......................................*........*.......*..........................
                ...*..*................................*................................*..*............................................................*......................................*....................*....
                .................**.........*.......*........*..................................**......................*......................*...........................*........*.......*.........*......*...........
                ......*...*.............*.........................................*...*......*.......*....*........................................*......*.........*.............*......................................
                ...........................*..*.......*........*...................*.**......**...*..................................*..........*....*...................*........*.......*......*..*..........*........*
                .......................*.........*...................*......*..................*........*....*.........................*...**....*...............................*.........................*....*........
                .....................*..............................*...........................*..............................................*.....*..............................................................*..*.
                .............*..............*....................................................*......................*....**....**...............................................*..............*..............*......
                *......................*......*.................*....................*................*.................................*..................*.............................*...............*.......*.......
                ....*.......................*...................................*.............*.....*...........................*..................................................................*.....................
                ...*............................*......................................*.........................................*.....................................*...*...................*...............*.....*...
                ...............................*...........*...................................*...............*......*.........*......*............*....*.........................................*............*........
                ...*.......*.............*..........*..................................*...................................*.....................................*...........*............*.......................*......
                .......*.....................*.................................*..............*...*................................*.................................*..*.....................*..........*...............
                ..................................................*.................................*...........................................*....*..*.....*.................................*......................**
                *......*......................*......................................*....................*...*.......*....*.....*........................................**...............*..........*................**
            """.trimIndent().split("\n").map { it.toList() }

            val stars = input.flatMapIndexed { rowIndex, row ->
                row.mapIndexedNotNull { colIndex, c ->
                    if (c == '*') {
                        rowIndex to colIndex
                    } else {
                        null
                    }
                }
            }

            class Edge(val first: Pair<Int, Int>, val second: Pair<Int, Int>, val distance: Int) : Comparable<Edge> {
                override fun compareTo(other: Edge): Int {
                    return distance.compareTo(other.distance)
                }
            }

            val edges = stars.flatMap { first ->
                stars.mapNotNull { second ->
                    if (first != second) {
                        val (x1, y1) = first
                        val (x2, y2) = second
                        val distance = abs(x1 - x2) + abs(y1 - y2)
                        if (distance < 6) {
                            Edge(first, second, distance)
                        } else {
                            null
                        }
                    } else {
                        null
                    }
                }
            }.sorted().toMutableList()

            val constellation = mutableSetOf<Pair<Int, Int>>()
            var distance = 0
            val scores = mutableListOf<Int>()

            while (true) {
                val edge = edges.firstOrNull { (it.first in constellation) xor (it.second in constellation) }
                if (edge == null) {
                    scores.add(distance + constellation.size)

                    if (edges.isEmpty()) {
                        break
                    }

                    val nextEdge = edges.removeFirst()
                    constellation.clear()
                    constellation.add(nextEdge.first)
                    constellation.add(nextEdge.second)
                    distance = nextEdge.distance
                } else {
                    distance += edge.distance
                    constellation.add(edge.first)
                    constellation.add(edge.second)
                    edges.removeIf { it.first in constellation && it.second in constellation }
                }
            }

            println(scores.map { it.toLong() }.sorted().takeLast(3).reduce(Long::times))
        }
    }
}